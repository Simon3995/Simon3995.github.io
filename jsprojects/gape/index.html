<!DOCTYPE html>
<html>
<head><title>GAPE</title></head>
<button onclick="saveNetwork()">Save basenetwork</button>
<button onclick="loadNetwork()">Input basenetwork</button><br><br>
<canvas id="canvas"></canvas><br><br>
<canvas id="canvas2"></canvas><br><br>
<canvas id="canvas3"></canvas>
<audio class="sfx" id="jump" src="sounds\jump.wav" preload="auto"></audio>
<audio class="sfx" id="win" src="sounds\win.wav" preload="auto"></audio>
<audio class="sfx" id="death" src="sounds\death.wav" preload="auto"></audio>
<style>
canvas {
	border:2px solid #000;
}
body {
	background-color : #696969;
}
</style>
</html>
<script type="text/javascript">
!function(){var e=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;window.requestAnimationFrame=e}();var channel_max=10;for(audiochannels=new Array,a=0;a<channel_max;a++)audiochannels[a]=new Array,audiochannels[a].channel=new Audio,audiochannels[a].finished=-1;function play_multi_sound(e){for(a=0;a<audiochannels.length;a++)thistime=new Date}var canvas=document.getElementById("canvas"),canvas2=document.getElementById("canvas2"),canvas3=document.getElementById("canvas3"),ctx=canvas.getContext("2d"),ctx2=canvas2.getContext("2d"),ctx3=canvas3.getContext("2d"),width=800,height=200,keys=[],friction=.8,gravity=.4;nnPerGen=10;var nn=[],gatesAmt=35;for(i=1;i<=nnPerGen;i++)for(nn[i]=[],nn[i][0]=[],j=1;j<=gatesAmt;j++)nn[i][j]=[],nn[i][j][1]=!1;var blood={amt:100,x:[],y:[],velx:[],vely:[],size:4,limit:15,vector:[]},eye={amt:361,dist:12},obDim=Math.floor(Math.sqrt(eye.amt)),mouseX=0,mouseY=0,deathwall=-300,lastfitness=0;canvas2.height=500,canvas2.width=800,canvas3.height=200,canvas3.width=200;var boxes=[];for(sensorOutput=[],i=0;i<=obDim;i++)sensorOutput[i]=[];if(temp=prompt("Input level here. You can enter 'standard' to load the standard level.","standard"),"standard"===temp){boxes.push({x:-5,y:height-5,width:120,height:1e3,type:0}),boxes.push({x:300,y:height-5,width:120,height:1e3,type:0}),boxes.push({x:-1e3,y:-500,width:1e3,height:2e3,type:0}),boxes.push({x:width,y:0,width:1e3,height:height,type:0}),spawnX=20,spawnY=height/2;var finishX=785;canvas.width=width,canvas.height=height,boxes.push({x:40,y:height-30,width:40,height:30,type:0}),boxes.push({x:150,y:height-100,width:40,height:30,type:0}),boxes.push({x:160,y:height-100,width:20,height:300,type:0}),boxes.push({x:460,y:height-60,width:40,height:300,type:0}),boxes.push({x:520,y:height-90,width:40,height:300,type:0}),boxes.push({x:580,y:height-120,width:40,height:300,type:0}),boxes.push({x:700,y:170,width:2e3,height:600,type:0}),boxes.push({x:700,y:-500,width:300,height:630,type:0}),boxes.push({x:360,y:-500,width:15,height:680,type:1}),boxes.push({x:670,y:-500,width:30,height:515,type:1}),boxes.push({x:finishX,y:130,width:15,height:40,type:2})}else{for(level=temp.split("%"),level[0]=level[0].split(","),spawnX=Number(level[0][0]),spawnY=Number(level[0][1]),level[1]=level[1].split(","),canvas.width=Number(level[1][0]),canvas.height=Number(level[1][1]),temp5=level[2].split("#"),i=1;i<=temp5[0];i++)temp2=temp5[i].split(","),boxes[i]={x:Number(temp2[0]),y:Number(temp2[1]),width:Number(temp2[2]),height:Number(temp2[3]),type:Number(temp2[4])};temp5=level[3].split(","),finishX=Number(temp5[0]),boxes[0]={x:finishX,y:Number(temp5[1]),width:Number(temp5[2]),height:Number(temp5[3]),type:2}}var player={x:spawnX,y:spawnY,width:10,height:15,speed:4,velX:0,velY:0,jumping:!0,grounded:!1};for(generation=1,nnOut={up:0,left:0,right:0},gateIn={A:!1,B:!1},networkNumber=1,baseNetwork=[],baseNetwork[0]=[],i=1;i<=gatesAmt;i++)baseNetwork[i]=[],baseNetwork[i][1]=!1;function update(){for(nnOut.up=0,nnOut.left=0,nnOut.right=0,i=1;i<=gatesAmt;i++)if(nn[networkNumber][i][1]){if(sensorOutput[nn[networkNumber][i][2]][nn[networkNumber][i][3]]==nn[networkNumber][i][4]?gateIn.A=!0:gateIn.A=!1,sensorOutput[nn[networkNumber][i][5]][nn[networkNumber][i][6]]==nn[networkNumber][i][7]?gateIn.B=!0:gateIn.B=!1,"BUFFER"===nn[networkNumber][i][8])var e=BUFFER(gateIn.A);if("AND"===nn[networkNumber][i][8])e=AND(gateIn.A,gateIn.B);if("NAND"===nn[networkNumber][i][8])e=NAND(gateIn.A,gateIn.B);if("NOR"===nn[networkNumber][i][8])e=NOR(gateIn.A,gateIn.B);if("XNOR"===nn[networkNumber][i][8])e=XNOR(gateIn.A,gateIn.B);if("XOR"===nn[networkNumber][i][8])e=XOR(gateIn.A,gateIn.B);if("OR"===nn[networkNumber][i][8])e=OR(gateIn.A,gateIn.B);if("NOT"===nn[networkNumber][i][8])e=NOT(gateIn.A);e&&("up"===nn[networkNumber][i][9]?nnOut.up+=nn[networkNumber][i][10]:"right"===nn[networkNumber][i][9]?nnOut.right+=nn[networkNumber][i][10]:"left"===nn[networkNumber][i][9]&&(nnOut.left+=nn[networkNumber][i][10]))}for(nnUp=!1,nnRight=!1,nnLeft=!1,nnOut.right-1>nnOut.left?nnRight=!0:nnOut.left-1>nnOut.right&&(nnLeft=!0),nnOut.up>=1&&(nnUp=!0),(deathwall+=3)>=player.x&&death(),nnUp&&!player.jumping&&player.grounded&&(player.jumping=!0,player.grounded=!1,player.velY=2*-player.speed,play_multi_sound("jump")),nnRight&&player.velX<player.speed&&player.velX++,nnLeft&&player.velX>-player.speed&&player.velX--,player.velX*=friction,player.velY+=gravity,ctx.fillStyle="white",ctx2.fillStyle="white",ctx.fillRect(0,0,canvas.width,canvas.height),ctx2.fillRect(0,0,canvas2.width,canvas2.height),ctx.fillStyle="black",ctx.beginPath(),player.grounded=!1,y=0;y<boxes.length;y++){var t=colCheck(player,boxes[y]);"l"===t||"r"===t?(player.velX=0,nnUp||(player.jumping=!1)):"b"===t?(player.grounded=!0,keys[38]||(player.jumping=!1)):"t"===t&&(player.velY*=-1),0==boxes[y].type&&(ctx.fillStyle="black"),1==boxes[y].type&&(ctx.fillStyle="red"),2==boxes[y].type&&(ctx.fillStyle="limegreen"),ctx.fillRect(boxes[y].x,boxes[y].y,boxes[y].width,boxes[y].height),ctx.fill()}for(player.grounded&&(player.velY=0),player.y>canvas.height&&death(),player.x+=player.velX,player.y+=player.velY,ctx.font="10px monospace",ctx.fill(),ctx.fillStyle="darkorange",ctx.fillRect(player.x,player.y,player.width,player.height),ctx.strokeStyle="red",ctx.beginPath(),ctx.moveTo(player.x+player.width/2,player.y+player.height/2),ctx.lineTo(player.x+player.width/2+20*player.velX,player.y+player.height/2+20*player.velY),ctx.stroke(),ctx.strokeStyle="blue",ctx.beginPath(),ctx.moveTo(player.x+player.width/2,player.y+player.height/2),ctx.lineTo(player.x+player.width/2,player.y+player.height/2+20*player.velY),ctx.stroke(),ctx.strokeStyle="green",ctx.beginPath(),ctx.moveTo(player.x+player.width/2,player.y+player.height/2),ctx.lineTo(player.x+player.width/2+20*player.velX,player.y+player.height/2),ctx.stroke(),ctx.strokeStyle="red",ctx.lineWidth=3,ctx.beginPath(),ctx.moveTo(deathwall,0),ctx.lineTo(deathwall,canvas.height),ctx.stroke(),ctx.lineWidth=1,i=1;i<=blood.amt;i++)ctx.fillStyle="red",ctx.fillRect(blood.x[i]-blood.size/2,blood.y[i]-blood.size/2,blood.size,blood.size),blood.x[i]+=blood.velx[i],blood.y[i]+=blood.vely[i],blood.velx[i]*=.8,blood.vely[i]+=.3;for(i=-1*Math.floor(obDim/2);i<=Math.floor(obDim/2);i++)for(j=-1*Math.floor(obDim/2);j<=Math.floor(obDim/2);j++)ctx.fillStyle="blue",ctx.fillRect(i*eye.dist+player.x+player.width/2,j*eye.dist+player.y+player.height/2,2,2);ctx.fillStyle="black",ctx.fillText("player.jumping = "+player.jumping,3,10),ctx.fillText("player.x = "+Math.round(player.x),3,20),ctx.fillText("player.y = "+Math.round(player.y),3,30),ctx.fillText("Mouse Coordinates: "+mouseX+", "+mouseY,3,40),ctx.fillText("Deathwall Position: "+Math.round(deathwall),3,50),ctx.fillText("player.grounded: "+player.grounded,3,60),ctx.fillText("Last Fitness: "+Math.round(lastfitness),3,70),ctx.fillText("Network Number: "+networkNumber,3,80),ctx.fillText("Generation: "+generation,3,90),ctx.fillText("Evolve Amount: "+evolveAmt,3,100),ctx.fillText("Continuity = "+continuity,3,110);var n=canvas2.height/(gatesAmt+1);for(i=1;i<=gatesAmt;i++)ctx2.font="normal normal normal 10px monospace",ctx2.fillStyle="dimgrey",nn[networkNumber][i][1]&&(ctx2.fillText(nn[networkNumber][i][8],canvas2.height+55,i*n+5),ctx2.strokeRect(canvas2.height+50,i*n-5,40,14));for(ctx2.strokeStyle="black",ctx2.lineWidth=1,i=0;i<=obDim;i++)ctx2.beginPath(),ctx2.moveTo(10,10+i*((canvas2.height-20)/obDim)),ctx2.lineTo(canvas2.height-10,10+i*((canvas2.height-20)/obDim)),ctx2.stroke();for(i=0;i<=obDim;i++)ctx2.beginPath(),ctx2.moveTo(10+i*((canvas2.height-20)/obDim),10),ctx2.lineTo(10+i*((canvas2.height-20)/obDim),canvas2.height-10),ctx2.stroke();for(ctx2.fillStyle="black",i=-1*Math.floor(obDim/2);i<=Math.floor(obDim/2);i++)for(j=-1*Math.floor(obDim/2);j<=Math.floor(obDim/2);j++)for(sensorOutput[i+Math.floor(obDim/2+1)][j+Math.floor(obDim/2+1)]=0,k=0;k<boxes.length;k++)i*eye.dist+player.x+player.width/2>=boxes[k].x&&i*eye.dist+player.x+player.width/2<=boxes[k].x+boxes[k].width&&j*eye.dist+player.y+player.height/2>=boxes[k].y&&j*eye.dist+player.y+player.height/2<=boxes[k].y+boxes[k].height&&(0==boxes[k].type?(ctx2.fillStyle="black",sensorOutput[i+Math.floor(obDim/2+1)][j+Math.floor(obDim/2+1)]=1):1==boxes[k].type?(ctx2.fillStyle="red",sensorOutput[i+Math.floor(obDim/2+1)][j+Math.floor(obDim/2+1)]=2):2==boxes[k].type&&(ctx2.fillStyle="limegreen",sensorOutput[i+Math.floor(obDim/2+1)][j+Math.floor(obDim/2+1)]=3),ctx2.fillRect(10+(i+Math.floor(obDim/2))*((canvas2.height-20)/obDim),10+(j+Math.floor(obDim/2))*((canvas2.height-20)/obDim),(canvas2.height-20)/obDim,(canvas2.height-20)/obDim));for(ctx2.fillStyle="orange",ctx2.fillRect(10+Math.floor(obDim/2)*((canvas2.height-20)/obDim),10+Math.floor(obDim/2)*((canvas2.height-20)/obDim),(canvas2.height-20)/obDim,(canvas2.height-20)/obDim),i=1;i<=gatesAmt;i++)nn[networkNumber][i][1]&&(ctx2.beginPath(),ctx2.moveTo(10+(nn[networkNumber][i][2]-.5*Math.floor(obDim)+Math.floor(obDim/2))*((canvas2.height-20)/obDim),10+(nn[networkNumber][i][3]-.5*Math.floor(obDim)+Math.floor(obDim/2))*((canvas2.height-20)/obDim),(canvas2.height-20)/obDim,(canvas2.height-20)/obDim),ctx2.lineTo(canvas2.height+50,canvas2.height/(gatesAmt+1)*i),sensorOutput[nn[networkNumber][i][2]][nn[networkNumber][i][3]]==nn[networkNumber][i][4]?(ctx2.lineWidth=2,ctx2.strokeStyle="green"):(ctx2.lineWidth=1,ctx2.strokeStyle="dimgrey"),ctx2.stroke(),ctx2.beginPath(),ctx2.moveTo(10+(nn[networkNumber][i][5]-.5*Math.floor(obDim)+Math.floor(obDim/2))*((canvas2.height-20)/obDim),10+(nn[networkNumber][i][6]-.5*Math.floor(obDim)+Math.floor(obDim/2))*((canvas2.height-20)/obDim),(canvas2.height-20)/obDim,(canvas2.height-20)/obDim),ctx2.lineTo(canvas2.height+50,canvas2.height/(gatesAmt+1)*i),sensorOutput[nn[networkNumber][i][5]][nn[networkNumber][i][6]]==nn[networkNumber][i][7]?(ctx2.lineWidth=2,ctx2.strokeStyle="green"):(ctx2.lineWidth=1,ctx2.strokeStyle="dimgrey"),ctx2.stroke(),ctx2.beginPath(),ctx2.moveTo(canvas2.height+90,canvas2.height/(gatesAmt+1)*i),"up"===nn[networkNumber][i][9]?ctx2.lineTo(700,100):"left"===nn[networkNumber][i][9]?ctx2.lineTo(700,250):ctx2.lineTo(700,400),ctx2.lineWidth=1,ctx2.strokeStyle="dimgrey",ctx2.stroke());for(ctx2.font="20px Courier",nnUp?(ctx2.fillStyle="green",ctx2.font="normal normal bold 20px Courier"):(ctx2.fillStyle="dimgrey",ctx2.font="normal normal normal 20px Courier"),ctx2.fillText("UP",710,110),ctx2.font="normal normal normal 10px sans-serif",ctx2.fillStyle="dimgrey",ctx2.fillText(Math.floor(1e3*nnOut.up)/1e3,710,125),ctx2.strokeStyle="dimgrey",ctx2.strokeRect(700,90,80,40),nnLeft?(ctx2.fillStyle="green",ctx2.font="normal normal bold 20px Courier"):(ctx2.fillStyle="dimgrey",ctx2.font="normal normal normal 20px Courier"),ctx2.fillText("LEFT",710,260),ctx2.font="normal normal normal 10px sans-serif",ctx2.fillStyle="dimgrey",ctx2.fillText(Math.floor(1e3*nnOut.left)/1e3,710,275),ctx2.strokeStyle="dimgrey",ctx2.strokeRect(700,240,80,40),nnRight?(ctx2.fillStyle="green",ctx2.font="normal normal bold 20px Courier"):(ctx2.fillStyle="dimgrey",ctx2.font="normal normal normal 20px Courier"),ctx2.fillText("RIGHT",710,410),ctx2.font="normal normal normal 10px sans-serif",ctx2.fillStyle="dimgrey",ctx2.fillText(Math.floor(1e3*nnOut.right)/1e3,710,425),ctx2.strokeStyle="dimgrey",ctx2.strokeRect(700,390,80,40),networkNumber>3&&(nn[networkNumber],nn[networkNumber-2]),ctx3.fillStyle="white",ctx3.fillRect(0,0,canvas3.width,canvas3.height),ctx3.fillStyle="black",ctx3.fillText("Fitness of baseNets",5,10),generationFitness[generation]=baseNetwork[0][1],i=1;i<=generation;i++)ctx3.beginPath(),ctx3.moveTo(canvas3.width*((i-1)/generation),canvas3.height-canvas3.height*(generationFitness[i-1]/finishX)),ctx3.lineTo(canvas3.width*(i/generation),canvas3.height-canvas3.height*(generationFitness[i]/finishX)),ctx3.strokeStyle="blue",ctx3.stroke();requestAnimationFrame(update)}function colCheck(e,t){var n=e.x+e.width/2-(t.x+t.width/2),o=e.y+e.height/2-(t.y+t.height/2),i=Math.abs(e.width/2)+Math.abs(t.width/2),a=Math.abs(e.height/2)+Math.abs(t.height/2),r=null;if(Math.abs(n)<i&&Math.abs(o)<a)if(0==boxes[y].type){var l=i-Math.abs(n),h=a-Math.abs(o);l>=h?o>0?(r="t",e.y+=h):(r="b",e.y-=h):n>0?(r="l",e.x+=l):(r="r",e.x-=l)}else 1==boxes[y].type?death():2==boxes[y].type&&victory();return r}function death(){for(play_multi_sound("death"),lastfitness=player.x,nn[networkNumber][0][2]=deathwall,deathwall=-300,player.velX=0,player.velY=0,k=1;k<=blood.amt;k++)blood.velx[k]=30*Math.random()-15,blood.vely[k]=12*Math.random()-6,blood.vector[k]=Math.sqrt(blood.velx[k]*blood.velx[k]+8*blood.vely[k]*blood.vely[k]),blood.vector[k]>=blood.limit&&(blood.velx[k]*=blood.limit/blood.vector[k],blood.vely[k]*=blood.limit/blood.vector[k]),blood.x[k]=player.x,blood.y[k]=player.y;player.x=spawnX,player.y=spawnY,genAlg()}function victory(){saveNetwork(),play_multi_sound("win"),lastfitness=finishX,nn[networkNumber][0][2]=deathwall,deathwall=-300,player.velX=0,player.velY=0,player.x=spawnX,player.y=spawnY,genAlg()}function genAlg(){if(networkNumber<nnPerGen)for(nn[networkNumber][0][1]=lastfitness,nn[networkNumber][0][2]=deathwall,networkNumber++,nn[networkNumber]=JSON.parse(JSON.stringify(baseNetwork)),i=1;i<=evolveAmt;i++)evolveGate=Math.floor(gatesAmt*Math.random())+1,evolve();else{for(generation++,lastBaseNet=baseNetwork,i=1;i<=nnPerGen;i++)(nn[i][0][1]>baseNetwork[0][1]||(nn[i][0][1]=baseNetwork[0][1])&&nn[i][0][2]<baseNetwork[0][2])&&(baseNetwork=nn[i]);baseNetwork==lastBaseNet?continuity++:(continuity=0,evolveAmt=1),continuity>4&&evolveAmt<10&&evolveAmt++,networkNumber=1,nn[networkNumber]=JSON.parse(JSON.stringify(baseNetwork))}}function BUFFER(e){return!!e}function NOT(e){return!e}function AND(e,t){return!(!e||!t)}function XOR(e,t){return!(!e&&!t||e&&t)}function NAND(e,t){return!e||!t}function XNOR(e,t){return!!(!e&&!t||e&&t)}function OR(e,t){return!(!e&&!t)}function NOR(e,t){return!e&&!t}function evolve(){nn[networkNumber][evolveGate]=[],Math.random()>.2?(nn[networkNumber][evolveGate][1]=!0,nn[networkNumber][evolveGate][2]=Math.floor(Math.random()*Math.sqrt(eye.amt))+1,nn[networkNumber][evolveGate][3]=Math.floor(Math.random()*Math.sqrt(eye.amt))+1,nn[networkNumber][evolveGate][4]=Math.floor(3*Math.random()+1),nn[networkNumber][evolveGate][5]=Math.floor(Math.random()*Math.sqrt(eye.amt))+1,nn[networkNumber][evolveGate][6]=Math.floor(Math.random()*Math.sqrt(eye.amt))+1,nn[networkNumber][evolveGate][7]=Math.floor(3*Math.random()+1),randomGate=Math.floor(8*Math.random()),0==randomGate?nn[networkNumber][evolveGate][8]="BUFFER":1==randomGate?nn[networkNumber][evolveGate][8]="NOT":2==randomGate?nn[networkNumber][evolveGate][8]="AND":3==randomGate?nn[networkNumber][evolveGate][8]="XOR":4==randomGate?nn[networkNumber][evolveGate][8]="NAND":5==randomGate?nn[networkNumber][evolveGate][8]="XNOR":6==randomGate?nn[networkNumber][evolveGate][8]="OR":7==randomGate&&(nn[networkNumber][evolveGate][8]="NOR"),randomOutput=Math.random(),randomOutput<1/3?nn[networkNumber][evolveGate][9]="left":randomOutput<2/3?nn[networkNumber][evolveGate][9]="right":nn[networkNumber][evolveGate][9]="up",nn[networkNumber][evolveGate][10]=4*Math.random()-2):nn[networkNumber][evolveGate][1]=!1}function saveNetwork(){for(temp=baseNetwork[0],i=1;i<=gatesAmt;i++)temp+="["+baseNetwork[i];prompt("Saved Network:",temp)}function loadNetwork(){for(baseNetwork=prompt("You can paste a neural network here.").split("["),i=0;i<=gatesAmt;i++){if(baseNetwork[i]=baseNetwork[i].split(","),"false"==baseNetwork[i][1])baseNetwork[i][1]=!1;else if(0!=i)for(j=2;j<=10;j++)8!=j&&9!=j&&(baseNetwork[i][j]=Number(baseNetwork[i][j]));Number(baseNetwork[0][1]),Number(baseNetwork[0][2])}player.x=-1e3,nn[networkNumber][0][1]=-1e3,generation=1,networkNumber=1,baseNetwork[0][1]=0,generationFitness[0]=baseNetwork[0][1]}baseNetwork[0][1]=20,baseNetwork[0][2]=-300,evolveAmt=1,generationFitness=[],generationFitness[0]=20,lastBaseNet=0,continuity=0,document.body.addEventListener("keydown",(function(e){keys[e.keyCode]=!0})),document.body.addEventListener("keyup",(function(e){keys[e.keyCode]=!1})),canvas.addEventListener("mousemove",(function(e){mouseX=e.clientX-canvas.offsetLeft,mouseY=e.clientY-canvas.offsetTop}),!1),window.addEventListener("load",(function(e){e.clientX,canvas.offsetLeft,e.clientY,canvas.offsetTop;update()}));
</script>